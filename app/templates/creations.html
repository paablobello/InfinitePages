{% extends 'base.html' %}

{% block content %}
<div class="container my-5">
  <!-- Formulario de creación de historias -->
  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="card-title text-center mb-4">Generador de cuentos e historias</h2>
          <form id="story-form" method="post">
            <div class="form-group">
              <label for="description">Describir la historia*</label>
              <textarea class="form-control" id="description" name="description" rows="3" placeholder="Describe brevemente tu idea de historia..." required></textarea>
            </div>
            <div class="form-group">
              <label for="genre">Género</label>
              <select id="genre" name="genre" class="form-control" required>
                <option value="">Selecciona un género</option>
                <option value="ficcion">Ficción</option>
                <option value="realista">Realista</option>
                <option value="aventura">Aventura</option>
                <option value="ciencia-ficcion">Ciencia ficción</option>
                <option value="misterio">Misterio</option>
                <option value="romance">Romance</option>
                <option value="terror">Terror</option>
                <option value="infantil">Infantil</option>
              </select>
            </div>
            <div class="form-group">
              <label for="creativity_level">Nivel de creatividad</label>
              <select id="creativity_level" name="creativity_level" class="form-control" required>
                <option value="">Selecciona un nivel</option>
                <option value="low">Bajo</option>
                <option value="medium">Medio</option>
                <option value="high">Alto</option>
              </select>
            </div>
            <div class="form-group">
              <label for="word_count">Longitud de la historia</label>
              <input type="range" id="word_count" name="word_count" min="100" max="1000" value="500" class="custom-range">
              <span id="word_count_value" class="form-text">de 100 a 1000 palabras</span>
            </div>
            <div class="form-group">
              <label for="language">Idioma</label>
              <select id="language" name="language" class="form-control" required>
                <option value="es">Español</option>
                <option value="gl">Gallego</option>
                <option value="en">Inglés</option>
                <option value="fr">Francés</option>
                <option value="de">Alemán</option>
                <option value="it">Italiano</option>
                <option value="zh">Chino</option>
              </select>
            </div>
            <button type="submit" id="generate-button" class="btn btn-primary btn-block">Generar</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Resultados de la generación de historias -->
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="card-title text-center mb-4">Su resultado</h2>
          {% if generated_text %}
          <div class="border p-4 rounded-lg" id="resultado">
              <img src="{{ cover_url }}" alt="Portada del libro" class="cover-image mb-3">
              {{ generated_text }}
          </div>
          <form method="post" action="{{ url_for('creations.save_book') }}" class="mt-3">
              <input type="hidden" name="title" value="{{ generated_title }}">
              <input type="hidden" name="content" value="{{ generated_text }}">
              <input type="hidden" name="cover_url" value="{{ cover_url }}">
              <button type="submit" class="btn btn-success btn-block">Guardar</button>
          </form>
          {% else %}
          <div class="border p-4 rounded-lg" id="resultado">
              <p class="text-muted">Tus resultados generados se mostrarán aquí.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Libros generados -->
  <h2 class="text-center mb-4">Mis libros creados</h2>
  {% if books %}
  <div class="row">
    {% for book in books %}
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <img src="{{ book.cover_url }}" alt="Portada del libro" class="cover-image mb-3">
          <h3 class="card-title">{{ book.title }}</h3>
          <p class="card-text">{{ book.content }}</p>
          <div class="d-flex justify-content-between align-items-center">
            <form method="post" action="{{ url_for('creations.toggle_publish_book', book_id=book.id) }}" style="display:inline;">
              <label class="switch">
                <input type="checkbox" class="publish-switch" data-book-id="{{ book.id }}" {% if book.published %}checked{% endif %}>
                <span class="slider round"></span>
              </label>
              <span class="switch-label">{{ 'Publicado' if book.published else 'No Publicado' }}</span>
            </form>
            <form method="post" action="{{ url_for('creations.delete_book', book_id=book.id) }}" onsubmit="return confirmDelete(event);" style="display:inline;">
              <button type="submit" class="btn btn-danger">Eliminar</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="text-center text-muted">No se han generado libros aún.</p>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const wordCountInput = document.getElementById('word_count');
    const wordCountValue = document.getElementById('word_count_value');

    wordCountInput.addEventListener('input', () => {
      wordCountValue.innerText = `Longitud seleccionada: ${wordCountInput.value} palabras`;
    });

    // Inicializa el texto del span con el valor por defecto
    wordCountValue.innerText = `Longitud seleccionada: ${wordCountInput.value} palabras`;

    // Añadir funcionalidad para el switch de publicación
    const publishSwitches = document.querySelectorAll('.publish-switch');
    publishSwitches.forEach(switchElement => {
      const bookId = switchElement.getAttribute('data-book-id');
      const isPublished = switchElement.checked;
      const label = switchElement.parentElement.nextElementSibling;
      label.innerText = isPublished ? 'Publicado' : 'No Publicado';

      switchElement.addEventListener('change', function () {
        const isPublished = switchElement.checked;

        fetch(`/creations/toggle_publish_book/${bookId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            label.innerText = isPublished ? 'Publicado' : 'No Publicado';
          } else {
            console.error(data.message);
          }
        })
        .catch(error => console.error('Error al actualizar el estado de publicación:', error));
      });
    });
  });

  function confirmDelete(event) {
    event.preventDefault();
    if (confirm("¿Estás seguro de que deseas eliminar este libro?")) {
      event.target.submit();
    }
  }
</script>
{% endblock %}
