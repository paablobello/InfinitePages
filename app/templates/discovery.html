{% extends 'base.html' %}

{% block content %}
<div class="container my-5">
    <div class="row">
        {% for book in books %}
        <div class="col-12 mb-4">
            <div class="card shadow-lg rounded">
                <div class="row no-gutters">
                    <div class="col-md-4">
                        <img src="path_to_placeholder_image.jpg" class="card-img" alt="book cover">
                    </div>
                    <div class="col-md-8">
                        <div class="card-body">
                            <h2 class="card-title">{{ book['title'] }}</h2>
                            <p class="card-text">{{ book['content'] }}</p>
                            <div class="book-details d-flex justify-content-between align-items-center">
                                <span class="text-muted">Publicado por: {{ book['username'] }}</span>
                                <!-- Botón de Me gusta -->
                                <form method="post" action="{{ url_for('discovery.toggle_favorite', book_id=book['id']) }}" style="display: inline;">
                                    <button type="submit" class="btn btn-link like-button {% if book['id'] in user_favorites %}liked{% endif %}" data-book-id="{{ book['id'] }}">
                                        <i class="fas fa-heart"></i> Me gusta
                                    </button>
                                </form>
                            </div>
                            <!-- Sección de comentarios -->
                            <div class="comments-section mt-4">
                                <h3 class="h5">Comentarios</h3>
                                <div class="comments-list">
                                    {% for comment in book.comments %}
                                    <div class="comment mb-2">
                                        <strong>{{ comment.username }}</strong>: {{ comment.text }}
                                    </div>
                                    {% endfor %}
                                </div>
                                <form method="post" action="{{ url_for('discovery.add_comment', book_id=book['id']) }}" class="mt-3">
                                    <div class="input-group">
                                        <input type="text" name="comment" class="form-control" placeholder="Añadir un comentario..." required>
                                        <div class="input-group-append">
                                            <button type="submit" class="btn btn-primary">Comentar</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <p class="text-center text-muted">No se han encontrado libros para mostrar.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const likeButtons = document.querySelectorAll('.like-button');

    likeButtons.forEach(button => {
      button.addEventListener('click', function (event) {
        event.preventDefault();
        const isLiked = button.classList.contains('liked');
        const bookId = button.getAttribute('data-book-id');

        fetch(`/toggle_favorite/${bookId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ liked: !isLiked })
        })
        .then(response => {
          if (response.ok) {
            button.classList.toggle('liked', !isLiked);
          } else {
            console.error('Error al actualizar el estado de favorito');
          }
        })
        .catch(error => console.error('Error en la solicitud:', error));
      });
    });
  });
</script>
{% endblock %}
